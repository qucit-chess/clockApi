<!DOCTYPE html>
<html>

<head>
  <title>Clock Chess</title>
  <meta charset="UTF-8">
  <meta name="description" content="" />
  <meta name="keywords" content="" />
</head>

<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>
    function clock() {
      fetch('http://192.168.100.100:5000/clock', {
        method: "GET"
      });
    }

    $(document).ready(function() {
      init();
    });

    stopIntervals();
    var DURATION = 300;
    var INCREMENT = 3;
    var clockP1 = DURATION;
    var clockP2 = DURATION;
    var intervalP1 = null;
    var intervalP2 = null;
    var currentPlayer = 0;
    var isPaused = null;
    var lastAction = null;

    function init() {
      console.log('init')
      var lastAction = 'init';
      stopIntervals();
      clockP1 = DURATION;
      clockP2 = DURATION;
      intervalP1 = null;
      intervalP2 = null;
      currentPlayer = 0;
      pause(null);
      $('.player1').html(formatClock(clockP1));
      $('.player2').html(formatClock(clockP2));
      $('.play').addClass('disabled');
    }

    function playPause() {
      console.log('play')
      if (isPaused == null) {
        return;
      }
      lastAction = 'play';
      stopIntervals();
      if (isPaused && currentPlayer === 1) {
        pause(false);
        player1();
      } else if (currentPlayer === 2) {
        pause(false);
        player2();
      } else {
        pause(true);
      }
    }

    function pause(_isPaused) {
      isPaused = _isPaused;
      if (_isPaused) {
        $('.player1').addClass('disabled');
        $('.player2').addClass('disabled');
      } else {
        $('.player1').removeClass('disabled');
        $('.player2').removeClass('disabled');
      }
    }

    function player1() {
      console.log('player1')
      if (lastAction == 'player1') {
        return;
      }
      lastAction = 'player1';
      if (isPaused === true) {
        return;
      }
      $('.play').removeClass('disabled');
      if (isPaused !== null) {
        clockP1 += INCREMENT;
        $('.player1').html(formatClock(clockP1));
      }

      pause(false);
      currentPlayer = 1;
      stopIntervals();

      clock();

      intervalP2 = setInterval(function() {
        if (clockP2 > 0) {
          clockP2 -= 1;
          $('.player2').html(formatClock(clockP2));
        } else {
          stopIntervals();
          $('.player2').html('P2 has lost');
        }
      }, 1000);
    }

    function formatClock(clock) {
      var minutes = parseInt(clock / 60, 10);
      var seconds = clock % 60;
      seconds = seconds < 10 ? '0' + seconds : seconds;
      return minutes + ':' + seconds;
    }

    function player2() {
      console.log('player2')
      if (lastAction == 'player2') {
        return;
      }
      lastAction = 'player2';
      if (isPaused === true) {
        return;
      }
      $('.play').removeClass('disabled');
      if (isPaused !== null) {
        clockP2 += INCREMENT;
        $('.player2').html(formatClock(clockP2));
      }

      pause(false);
      currentPlayer = 2;
      stopIntervals();

      clock();

      intervalP1 = setInterval(function() {
        if (clockP1 > 0) {
          clockP1 -= 1;
          $('.player1').html(formatClock(clockP1));
        } else {
          stopIntervals();
          $('.player1').html('P1 has lost');
        }
      }, 1000);
    }

    function stopIntervals() {
      if (intervalP1 !== null) {
        clearInterval(intervalP1);
        intervalP1 = null;
      }
      if (intervalP2 !== null) {
        clearInterval(intervalP2);
        intervalP2 = null;
      }
    }

  </script>

  <style>
    .button {
      outline: none;
      min-width: 200px;
      padding: 80px 20px;
      margin: 5px;
      background-color: #EFEFEF;
      border: 1px solid #DDD;
      border-radius: 3px;
      cursor: pointer;
      color: #444;
    }

    .button-small {
      padding: 10px;
      display: inline-block;
      min-width: 93px;
    }

    .button:hover {
      background-color: #E0E0E0;
    }

    .button.disabled {
      cursor: default;
    }

    .button.disabled:hover {
      background-color: #BBB;
    }

    .disabled {
      background-color: #BBB;
    }

  </style>

  <button class="button player1" onclick="player1()"></button>
  <br>

  <button class="button button-small play" onclick="playPause()">▶/&#9208;</button>

  <button class="button button-small init" onclick="init()">↻</button>
  <br>

  <button class="button player2" onclick="player2()"></button>
</body>

</html>
